name: E2E Tests

on:
  workflow_dispatch: # Allow manual trigger
  # Uncomment below when E2E tests are fully implemented:
  # pull_request:
  #   branches: [main, develop]
  # push:
  #   branches: [main, develop]

env:
  FLUTTER_VERSION: '3.24.0'

jobs:
  # Android E2E Tests
  android-e2e:
    name: Android E2E Tests (Pixel 6)
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Create .env file for tests
        run: |
          echo "SUPABASE_URL=https://test.supabase.co" > .env
          echo "SUPABASE_ANON_KEY=test-anon-key" >> .env
          echo "ONESIGNAL_APP_ID=test-onesignal-id" >> .env
          echo "SUPERWALL_API_KEY=test-superwall-key" >> .env

      - name: Enable Android emulator KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: AVD cache
        uses: actions/cache@v4
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-pixel-6-api-33-e2e

      - name: Create AVD and generate snapshot for caching
        if: steps.avd-cache.outputs.cache-hit != 'true'
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33
          arch: x86_64
          profile: pixel_6
          target: google_apis
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: echo "Generated AVD snapshot for caching."

      - name: Run Android E2E Tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33
          arch: x86_64
          profile: pixel_6
          target: google_apis
          force-avd-creation: false
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: |
            flutter test integration_test/e2e/onboarding_flow_test.dart
            flutter test integration_test/e2e/fasting_flow_test.dart
            flutter test integration_test/e2e/panic_button_test.dart
            flutter test integration_test/e2e/hydration_flow_test.dart
            flutter test integration_test/e2e/session_completion_test.dart
            flutter test integration_test/e2e/offline_test.dart

      - name: Upload Android E2E Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-e2e-report
          path: |
            integration_test/reports/**/*
            flutter_logs.txt
          retention-days: 30

  # iOS E2E Tests
  ios-e2e:
    name: iOS E2E Tests (iPhone 13)
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Create .env file for tests
        run: |
          echo "SUPABASE_URL=https://test.supabase.co" > .env
          echo "SUPABASE_ANON_KEY=test-anon-key" >> .env
          echo "ONESIGNAL_APP_ID=test-onesignal-id" >> .env
          echo "SUPERWALL_API_KEY=test-superwall-key" >> .env

      - name: List available iOS simulators
        run: xcrun simctl list devices available

      - name: Start iPhone 13 Simulator
        run: |
          DEVICE_ID=$(xcrun simctl list devices | grep "iPhone 13" | grep -v "Pro" | head -1 | grep -oE '[0-9A-F-]{36}')
          echo "Using device: $DEVICE_ID"
          xcrun simctl boot $DEVICE_ID || true
          sleep 5

      - name: Run iOS E2E Tests
        run: |
          flutter test integration_test/e2e/onboarding_flow_test.dart
          flutter test integration_test/e2e/fasting_flow_test.dart
          flutter test integration_test/e2e/panic_button_test.dart
          flutter test integration_test/e2e/hydration_flow_test.dart
          flutter test integration_test/e2e/session_completion_test.dart
          flutter test integration_test/e2e/offline_test.dart

      - name: Upload iOS E2E Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-e2e-report
          path: |
            integration_test/reports/**/*
            flutter_logs.txt
          retention-days: 30

  # E2E Test Summary
  e2e-summary:
    name: E2E Test Summary
    runs-on: ubuntu-latest
    needs: [android-e2e, ios-e2e]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Android Report
        uses: actions/download-artifact@v4
        with:
          name: android-e2e-report
          path: reports/android
        continue-on-error: true

      - name: Download iOS Report
        uses: actions/download-artifact@v4
        with:
          name: ios-e2e-report
          path: reports/ios
        continue-on-error: true

      - name: Generate Summary
        run: |
          echo "# E2E Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Critical User Flows" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ Onboarding flow (6 screens)" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ Fasting start/complete flow" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ Panic button (early fast termination)" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ Water logging/hydration tracking" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ Session completion with metrics update" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ Offline functionality and sync recovery" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Platform Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- Android (Pixel 6, API 33): ${{ needs.android-e2e.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- iOS (iPhone 13): ${{ needs.ios-e2e.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "- Mocked external services (Supabase, OneSignal)" >> $GITHUB_STEP_SUMMARY
          echo "- Deterministic test data and scenarios" >> $GITHUB_STEP_SUMMARY
          echo "- Helper utilities for navigation and assertions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Notes" >> $GITHUB_STEP_SUMMARY
          echo "- E2E tests verify complete user workflows" >> $GITHUB_STEP_SUMMARY
          echo "- Tests include offline scenarios and sync recovery" >> $GITHUB_STEP_SUMMARY
          echo "- External services are mocked for deterministic results" >> $GITHUB_STEP_SUMMARY

      - name: Check test results
        run: |
          if [ "${{ needs.android-e2e.result }}" == "failure" ] || [ "${{ needs.ios-e2e.result }}" == "failure" ]; then
            echo "❌ E2E tests failed"
            exit 1
          else
            echo "✅ E2E tests passed"
          fi
